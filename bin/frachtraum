#!/usr/bin/env ruby
# -*- encoding : utf-8 -*-

require 'frachtraum'
require "thor"

class FrachtraumCLI < Thor
  
  desc "attach [DEPOT]", "decrypt and mount depot(s)"
  long_desc <<-LONGDESC
    `frachtraum attach` will prompt you for a password.
    
    The password is used to decrypt all depots specified
    in #{Frachtraum::CONFIG_FILE}

    You can optionally specify a single depot. In this case
    only this depot will be decrypted and mounted.
  LONGDESC
  def attach(depot=nil)
    
    case RUBY_PLATFORM
      when /bsd/   then Frachtraum.attach_bsd(depot)
      when /linux/ then Frachtraum.attach_linux(depot)
    end
  end
  
  # --------------
  
  desc "capacity", "calculate storage capacity"
  long_desc <<-LONGDESC
    `frachtraum capacity` will output capacity...

    lorem ipsum
  LONGDESC
  def capacity()
    # TODO
  end
  
  # --------------
  
  desc "diskreport", "lorem ipsum"
  long_desc <<-LONGDESC
    lorem ipsum
  LONGDESC
  def diskreport()
    # TODO
  end
  
  # --------------
  
  desc "list", "list depots"
  long_desc <<-LONGDESC
    lorem ipsum
  LONGDESC
  def listdepots()
    
    Frachtraum::DEPOTS.each{ |depot| puts depot }
    
  end
  
  # --------------
  
  desc "setupdisk", "setup a device as a new depot"
  long_desc <<-LONGDESC
    `frachtraum setup dev label` will setup...
    
    lorem ispum
  LONGDESC
  options :compression => :string, :encryption => :string, :keylength => :integer, :mountpoint => :string
  def setupdisk(dev,label)
    
    compression = options[:compression] ? options[:compression] : Frachtraum::DEFAULT_COMPRESSION
    encryption  = options[:encryption]  ? options[:encryption]  : Frachtraum::DEFAULT_ENCRYPTION
    keylength   = options[:keylength]   ? options[:keylength]   : Frachtraum::DEFAULT_KEYLENGTH
    mountpoint  = options[:mountpoint]  ? options[:mountpoint]  : Frachtraum::DEFAULT_MOUNTPOINT
    
    case RUBY_PLATFORM
      when /bsd/   then Frachtraum.setupdisk_bsd(dev, label, compression, encryption, keylength, mountpoint)
      when /linux/ then Frachtraum.setupdisk_linux(dev, label, compression, encryption, keylength, mountpoint)
    end
    
  end
  
  # --------------
  
  desc "test", "test system for compatibility"
  long_desc <<-LONGDESC
    `frachtraum test` will test...

    lorem ipsum
  LONGDESC
  def test()
    Frachtraum.run_system_test
  end
end
 
FrachtraumCLI.start(ARGV)